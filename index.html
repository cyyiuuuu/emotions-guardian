<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情緒守護</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#78aed5',
                        secondary: '#e0f2fe',
                        dark: {
                            primary: '#6ca0c7',
                            secondary: '#0f172a'
                        }
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        * {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .main-icon {
            transition: transform 0.2s ease-in-out;
        }
        
        .main-icon:hover {
            transform: scale(1.05);
        }
        
        .page {
            transition: all 0.4s ease;
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: translateY(20px);
        }
        
        .page.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
            position: relative;
        }
        
        .heart-animation {
            animation: pulse 1.5s ease infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .dark .emoji-btn {
            background-color: #1e293b;
            color: white;
        }
        
        .dark #map {
            filter: invert(90%) hue-rotate(180deg);
        }
        
        .back-btn {
            transition: all 0.2s ease;
        }
        
        .back-btn:hover {
            transform: translateX(-3px);
        }
        
        /* 呼吸圈動畫 */
        .breath-circle {
            transition: transform 0.4s ease-in-out;
        }
        
        .breath-animation-inhale {
            animation: inhale 4s ease-in-out;
        }
        
        .breath-animation-hold {
            animation: hold 4s ease-in-out;
        }
        
        .breath-animation-exhale {
            animation: exhale 6s ease-in-out;
        }
        
        @keyframes inhale {
            from { transform: scale(1); }
            to { transform: scale(1.5); }
        }
        
        @keyframes hold {
            from { transform: scale(1.5); }
            to { transform: scale(1.5); }
        }
        
        @keyframes exhale {
            from { transform: scale(1.5); }
            to { transform: scale(1); }
        }
        
        /* 音樂播放控制樣式 */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e2e8f0;
            cursor: pointer;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #78aed5;
            width: 0%;
            transition: width 0.1s;
        }
        
        .audio-control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .audio-control-btn:hover {
            transform: scale(1.1);
        }
        
        /* 顏色配對遊戲樣式 */
        .color-tile {
            width: 100%;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .color-tile:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .target-color {
            width: 80px;
            height: 80px;
            border-radius: 0.5rem;
            margin: 0 auto;
            border: 2px solid #e2e8f0;
        }
        
        /* 點擊波紋效果 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple {
            to {
                transform: scale(2);
                opacity: 0;
            }
        }
        
        /* 形狀匹配遊戲樣式 */
        .shape-card {
            width: 100%;
            aspect-ratio: 1/1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            perspective: 1000px;
            transform-style: preserve-3d;
        }

        .shape-card:hover {
            transform: scale(1.05);
        }
        
        .shape-container {
            width: 80%;
            height: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 音量調節滑塊樣式 */
        input[type=range].volume-slider {
            height: 25px;
            -webkit-appearance: none;
            margin: 10px 0;
            width: 100%;
            background: transparent;
        }
        
        input[type=range].volume-slider:focus {
            outline: none;
        }
        
        input[type=range].volume-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            animate: 0.2s;
            box-shadow: 0px 0px 0px #000000;
            background: #e2e8f0;
            border-radius: 3px;
            border: 0px solid #000000;
        }
        
        .dark input[type=range].volume-slider::-webkit-slider-runnable-track {
            background: #384152;
        }
        
        input[type=range].volume-slider::-webkit-slider-thumb {
            box-shadow: 0px 0px 0px #000000;
            border: 2px solid #78aed5;
            height: 18px;
            width: 18px;
            border-radius: 25px;
            background: #FFFFFF;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
        }
        
        .dark input[type=range].volume-slider::-webkit-slider-thumb {
            background: #78aed5;
            border-color: white;
        }
        
        .music-type {
            transition: all 0.2s ease;
        }
        
        .music-type.active {
            background-color: #78aed5;
            color: white;
        }
        
        .music-type.active:hover {
            background-color: #6ca0c7;
        }
        
        .dark .music-type.active {
            background-color: #6ca0c7;
        }
        
        .dark .music-type.active:hover {
            background-color: #5d91b8;
        }
        
        /* 文件上傳樣式 */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            cursor: pointer;
            display: block;
        }
        
        /* 餐廳地圖標記樣式 */
        .map-marker {
            width: 30px;
            height: 30px;
            background-color: #78aed5;
            border-radius: 50% 50% 50% 0;
            position: absolute;
            transform: rotate(-45deg);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .map-marker:hover {
            transform: rotate(-45deg) scale(1.2);
        }
        
        .map-marker::after {
            content: '';
            width: 14px;
            height: 14px;
            margin: 8px 0 0 8px;
            background-color: white;
            position: absolute;
            border-radius: 50%;
        }
        
        .restaurant-card {
            transition: all 0.3s ease;
        }
        
        .restaurant-card:hover {
            transform: translateY(-5px);
        }
        
        /* 上传和移除按钮 */
        .upload-btn-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .upload-btn-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        
        .uploaded-file {
            display: flex;
            align-items: center;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .dark .uploaded-file {
            background-color: #374151;
        }
        
        .playlist-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .playlist-item:hover {
            background-color: #e5e7eb;
        }
        
        .dark .playlist-item:hover {
            background-color: #4b5563;
        }
        
        .playlist-item.active {
            background-color: #dbeafe;
        }
        
        .dark .playlist-item.active {
            background-color: #1e3a8a;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl min-h-screen relative">
        <!-- 主頁面 -->
        <div id="mainPage" class="page active">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary dark:text-dark-primary">情緒守護</h1>
                <p class="text-gray-600 dark:text-gray-300 mt-2">提供情緒管理與生活輔助功能</p>
            </header>
            
            <div class="grid grid-cols-2 gap-6 mb-6">
                <!-- 音樂功能 - 左上角 -->
                <div>
                    <button id="musicBtn" class="main-icon bg-primary dark:bg-dark-primary hover:bg-blue-400 dark:hover:bg-blue-500 text-white w-full aspect-square rounded-2xl shadow-lg flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                        <span class="text-lg font-bold">嘈音消除</span>
                    </button>
                </div>
                
                <!-- 情緒監測 - 右上角 -->
                <div>
                    <button id="emotionBtn" class="main-icon bg-primary dark:bg-dark-primary hover:bg-blue-400 dark:hover:bg-blue-500 text-white w-full aspect-square rounded-2xl shadow-lg flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 heart-animation" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                        <span class="text-lg font-bold">情緒檢測</span>
                    </button>
                </div>
                
                <!-- 餐廳推薦 - 左中 -->
                <div>
                    <button id="restaurantBtn" class="main-icon bg-primary dark:bg-dark-primary hover:bg-blue-400 dark:hover:bg-blue-500 text-white w-full aspect-square rounded-2xl shadow-lg flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <span class="text-lg font-bold">友善餐廳</span>
                    </button>
                </div>
                
                <!-- 迷你遊戲 - 右中 -->
                <div>
                    <button id="gamesBtn" class="main-icon bg-primary dark:bg-dark-primary hover:bg-blue-400 dark:hover:bg-blue-500 text-white w-full aspect-square rounded-2xl shadow-lg flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="text-lg font-bold">迷你遊戲</span>
                    </button>
                </div>
                
                <!-- 設置 - 下方 -->
                <div class="col-span-2">
                    <button id="settingsBtn" class="main-icon bg-primary dark:bg-dark-primary hover:bg-blue-400 dark:hover:bg-blue-500 text-white w-full py-4 rounded-2xl shadow-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span class="text-xl font-bold">設置</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 音樂頁面 -->
        <div id="musicPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="musicBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">嘈音消除</h2>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">連接耳機</h3>
                    <button id="connectHeadphones" class="bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition w-full sm:w-auto">
                        連接藍牙耳機
                    </button>
                    <p id="headphoneStatus" class="mt-2 text-gray-500 dark:text-gray-400">未連接</p>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-2">上傳您的音樂</h3>
                    <p class="text-gray-600 dark:text-gray-400 text-sm mb-4">上傳您喜歡的音樂，在情緒不穩定時自動播放</p>
                    
                    <div class="upload-btn-wrapper mb-4">
                        <button class="bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition w-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            選擇音樂檔案 (.mp3)
                        </button>
                        <input type="file" id="musicUpload" accept="audio/mp3" multiple />
                    </div>
                    
                    <div id="uploadedFiles" class="mb-4">
                        <!-- 上傳的檔案會顯示在這裡 -->
                    </div>
                    
                    <div id="userPlaylist" class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-4">
                        <h4 class="font-medium mb-2">我的音樂</h4>
                        <div id="userPlaylistItems" class="max-h-40 overflow-y-auto">
                            <p class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">尚未上傳音樂</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">選擇音樂類型</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button data-sound="https://pfst.cf2.poecdn.net/base/audio/30816ad23d2cb85a2a1a58bd63bc78118444d0c9c45289630d8235418286b7bd" class="music-type bg-secondary dark:bg-blue-900 py-4 px-4 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">輕鬆音樂</button>
                        <button data-sound="https://pfst.cf2.poecdn.net/base/audio/24916ca12e20fbfb99f4c9cfc189dbdadd8e60489d9070c3d73c65de9f8db3fa" class="music-type bg-secondary dark:bg-blue-900 py-4 px-4 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">自然聲音</button>
                        <button data-sound="https://pfst.cf2.poecdn.net/base/audio/85d66c040d1f9cefd01eb1883670b611ca6b632582eb386e1085fd01630fee43" class="music-type bg-secondary dark:bg-blue-900 py-4 px-4 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">白噪音</button>
                        <button data-sound="https://pfst.cf2.poecdn.net/base/audio/14e77731250f352c18ce908ead88e75341a92767a874dd748f3f228dd621297e" class="music-type bg-secondary dark:bg-blue-900 py-4 px-4 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition">粉紅噪音</button>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">音量</h3>
                    <input type="range" min="0" max="100" value="80" class="volume-slider w-full accent-primary" id="volumeControl">
                    <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                        <span>0</span>
                        <span>50</span>
                        <span>100</span>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">當前播放</h3>
                    <div class="bg-secondary dark:bg-blue-900 rounded-lg p-6">
                        <div class="flex items-center mb-4">
                            <div class="mr-5">
                                <div id="audioVisualizer" class="w-16 h-16 bg-primary rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                    </svg>
                                </div>
                            </div>
                            <div class="flex-1">
                                <p id="nowPlayingTitle" class="font-semibold text-lg">未選擇音樂</p>
                                <p id="nowPlayingTime" class="text-gray-600 dark:text-gray-300">0:00 / 0:00</p>
                            </div>
                        </div>
                        
                        <!-- 進度條 -->
                        <div class="mb-4">
                            <div id="progressBar" class="progress-bar">
                                <div id="progressFill" class="progress-fill"></div>
                            </div>
                        </div>
                        
                        <!-- 控制按鈕 -->
                        <div class="flex items-center justify-center space-x-5">
                            <button id="prevButton" class="audio-control-btn bg-blue-100 dark:bg-blue-800 text-primary dark:text-blue-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button id="playPauseButton" class="audio-control-btn bg-primary dark:bg-dark-primary text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" id="playIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" id="pauseIcon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </button>
                            <button id="nextButton" class="audio-control-btn bg-blue-100 dark:bg-blue-800 text-primary dark:text-blue-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- 循環和隨機播放選項 -->
                        <div class="flex justify-center space-x-6 mt-4">
                            <button id="loopButton" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                            <button id="shuffleButton" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-blue-100 dark:hover:bg-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 音效調節 -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4">音效調節</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">音調</label>
                            <input type="range" min="-12" max="12" value="0" class="volume-slider w-full accent-primary" id="pitchControl">
                            <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <span>低</span>
                                <span>正常</span>
                                <span>高</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">速度</label>
                            <input type="range" min="0.5" max="2" step="0.1" value="1" class="volume-slider w-full accent-primary" id="speedControl">
                            <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <span>慢</span>
                                <span>正常</span>
                                <span>快</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 隱藏的音頻元素 -->
                <audio id="audioPlayer" preload="auto"></audio>
            </div>
        </div>
        
        <!-- 情緒檢測頁面 -->
        <div id="emotionPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="emotionBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">情緒檢測</h2>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">智能手錶連接</h3>
                    <button id="connectWatch" class="bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition w-full sm:w-auto">
                        連接智能手錶
                    </button>
                    <p id="watchStatus" class="mt-2 text-gray-500 dark:text-gray-400">未連接</p>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">目前心跳</h3>
                    <div class="bg-secondary dark:bg-blue-900 rounded-lg p-8 text-center">
                        <div class="inline-block heart-animation">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mx-auto" fill="currentColor" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </div>
                        <p class="text-4xl font-bold mt-4" id="heartRate">75</p>
                        <p class="text-gray-600 dark:text-gray-300 text-lg">每分鐘心跳</p>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">情緒狀態</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <button class="emoji-btn bg-secondary dark:bg-blue-900 py-6 px-4 rounded-lg hover:bg-blue-200 text-4xl">😊</button>
                        <button class="emoji-btn bg-secondary dark:bg-blue-900 py-6 px-4 rounded-lg hover:bg-blue-200 text-4xl">😐</button>
                        <button class="emoji-btn bg-secondary dark:bg-blue-900 py-6 px-4 rounded-lg hover:bg-blue-200 text-4xl">😟</button>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-4">自動處理</h3>
                    <div class="space-y-4">
                        <div class="flex items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <input type="checkbox" id="autoPlayMusic" class="mr-3 h-5 w-5 accent-primary" checked>
                            <label for="autoPlayMusic" class="text-lg">情緒波動時自動播放音樂</label>
                        </div>
                        <div class="flex items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <input type="checkbox" id="notifyStaff" class="mr-3 h-5 w-5 accent-primary">
                            <label for="notifyStaff" class="text-lg">持續情緒不穩時通知車站職員</label>
                        </div>
                        <div class="flex items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <input type="checkbox" id="contactEmergency" class="mr-3 h-5 w-5 accent-primary" checked>
                            <label for="contactEmergency" class="text-lg">持續情緒不穩時聯絡緊急聯絡人</label>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">情緒紀錄</h3>
                    <div class="bg-secondary dark:bg-blue-900 rounded-lg p-4">
                        <!-- 視圖切換 (月/年) -->
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold">情緒概觀</h4>
                            <div class="flex space-x-2">
                                <button class="emotion-view-btn bg-primary text-white px-3 py-1 rounded-lg">月</button>
                                <button class="emotion-view-btn bg-gray-200 dark:bg-gray-700 px-3 py-1 rounded-lg">年</button>
                            </div>
                        </div>
                        
                        <!-- 月份/年份導航 -->
                        <div class="flex justify-between items-center mb-4">
                            <button class="prev-period-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <span id="currentPeriod" class="font-semibold">2023年6月</span>
                            <button class="next-period-btn p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- 月視圖 -->
                        <div id="monthView" class="emotion-view">
                            <!-- 星期標題 -->
                            <div class="grid grid-cols-7 gap-1 mb-2 text-center text-sm">
                                <div>日</div>
                                <div>一</div>
                                <div>二</div>
                                <div>三</div>
                                <div>四</div>
                                <div>五</div>
                                <div>六</div>
                            </div>
                            
                            <!-- 日曆網格 -->
                            <div id="monthGrid" class="grid grid-cols-7 gap-1">
                                <!-- 由 JavaScript 填充日期 -->
                            </div>
                        </div>
                        
                        <!-- 年視圖 -->
                        <div id="yearView" class="emotion-view hidden">
                            <div id="yearGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                <!-- 由 JavaScript 填充月份 -->
                            </div>
                        </div>
                        
                        <!-- 情緒圖例 -->
                        <div class="mt-4 flex flex-wrap items-center justify-center gap-3">
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-green-500 mr-1"></div>
                                <span class="text-sm">開心</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-yellow-500 mr-1"></div>
                                <span class="text-sm">平靜</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-red-500 mr-1"></div>
                                <span class="text-sm">焦慮</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-4 h-4 rounded-full bg-gray-300 dark:bg-gray-600 mr-1"></div>
                                <span class="text-sm">無數據</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 餐廳推薦頁面 -->
        <div id="restaurantPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="restaurantBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">自閉症友善餐廳</h2>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">您的位置</h3>
                    <div class="flex items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <span id="currentLocation" class="text-lg">旺角站</span>
                        <button id="refreshLocation" class="ml-auto bg-primary text-white p-2 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">搜尋餐廳</h3>
                    <div class="flex mb-3">
                        <input type="text" id="searchRestaurant" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="輸入餐廳名稱...">
                        <button id="searchBtn" class="bg-primary text-white py-3 px-4 rounded-lg ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- 監護人模式控制 -->
                <div id="guardianControls" class="mb-6 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">監護人模式</h3>
                        <button id="toggleGuardianMode" class="bg-primary text-white py-1 px-3 rounded-lg text-sm">
                            進入監護人模式
                        </button>
                    </div>
                    <div id="guardianModePanel" class="hidden">
                        <div class="mb-4">
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">添加常去餐廳</label>
                            <div class="flex">
                                <input type="text" id="newRestaurantName" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="輸入餐廳名稱">
                                <button id="addRestaurantBtn" class="bg-primary text-white py-2 px-4 rounded-lg ml-2">
                                    添加
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-medium mb-2">已添加的餐廳</h4>
                            <div id="favoriteRestaurants" class="max-h-40 overflow-y-auto space-y-2">
                                <!-- 管理現有餐廳 -->
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium mb-2">推薦餐廳</h4>
                            <div id="recommendedRestaurants" class="max-h-40 overflow-y-auto space-y-2">
                                <!-- 推薦餐廳列表 -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">附近餐廳</h3>
                    <div id="map" class="w-full h-64 bg-gray-200 rounded-lg mb-6 relative overflow-hidden">
                        <!-- 簡易地圖模擬 -->
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="relative w-full h-full">
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-10 h-10 bg-red-500 rounded-full flex items-center justify-center z-10">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <!-- 餐廳標記將由 JavaScript 動態添加 -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="restaurantsList" class="space-y-4">
                        <!-- 餐廳列表由 JavaScript 動態生成 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 餐廳詳細資訊頁面 -->
        <div id="restaurantDetailPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="restaurantDetailBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300" id="restaurantDetailName">餐廳名稱</h2>
                </div>
                
                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg mb-6">
                    <div class="flex items-start mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-3 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        <p id="restaurantDetailAddress" class="text-gray-700 dark:text-gray-300">餐廳地址</p>
                    </div>
                    <div class="flex items-start mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-3 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p id="restaurantDetailHours" class="text-gray-700 dark:text-gray-300">營業時間</p>
                    </div>
                    <div class="flex items-start">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary mr-3 mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <p id="restaurantDetailPhone" class="text-gray-700 dark:text-gray-300">電話</p>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">友善特點</h3>
                    <div id="restaurantDetailFeatures" class="flex flex-wrap gap-2">
                        <!-- 由 JavaScript 動態生成特點標籤 -->
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">餐廳介紹</h3>
                    <p id="restaurantDetailDescription" class="text-gray-700 dark:text-gray-300">餐廳描述</p>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="restaurantCallBtn" class="bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        撥打電話
                    </button>
                    <button id="restaurantNavigateBtn" class="bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                        </svg>
                        導航前往
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 迷你遊戲頁面 -->
        <div id="gamesPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="gamesBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">迷你遊戲</h2>
                </div>
                
                <p class="text-gray-600 dark:text-gray-300 mb-6">以下遊戲可以幫助訓練專注力和緩解情緒</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-secondary dark:bg-blue-900 rounded-2xl overflow-hidden shadow-md">
                        <div class="w-full h-40 bg-gradient-to-r from-blue-400 to-purple-400 flex items-center justify-center">
                            <div class="grid grid-cols-2 gap-2 p-4">
                                <div class="w-16 h-16 bg-red-500 rounded-lg"></div>
                                <div class="w-16 h-16 bg-yellow-500 rounded-lg"></div>
                                <div class="w-16 h-16 bg-green-500 rounded-lg"></div>
                                <div class="w-16 h-16 bg-blue-500 rounded-lg"></div>
                            </div>
                        </div>
                        <div class="p-5">
                            <h3 class="text-xl font-bold text-primary dark:text-blue-300 mb-2">顏色配對遊戲</h3>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">點擊與目標顏色相同的方塊，訓練反應速度和專注力</p>
                            <button id="startColorGame" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition">
                                開始遊戲
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-secondary dark:bg-blue-900 rounded-2xl overflow-hidden shadow-md">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMTUwIiBmaWxsPSJub25lIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iIzc4YWVkNSIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9Ijc1IiByPSI0MCIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjgpIiBzdHJva2U9IiM2Y2EwYzciIHN0cm9rZS13aWR0aD0iMyIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9Ijc1IiByPSIzMCIgZmlsbD0icmdiYSgxMjAsMTc0LDIxMywwLjUpIiBzdHJva2U9IiM2Y2EwYzciIHN0cm9rZS13aWR0aD0iMiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9Ijc1IiByPSIyMCIgZmlsbD0icmdiYSgxMjAsMTc0LDIxMywwLjcpIiBzdHJva2U9IiM2Y2EwYzciIHN0cm9rZS13aWR0aD0iMiIvPjxjaXJjbGUgY3g9IjEwMCIgY3k9Ijc1IiByPSIxMCIgZmlsbD0iIzZjYTBjNyIvPjxwYXRoIGQ9Ik02MCAzMGMwIDAgMjAgMjAgNDAgMjBzNDAtMjAgNDAtMjAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzIi8+PHBhdGggZD0iTTYwIDEyMGMwIDAgMjAtMjAgNDAtMjBzNDAgMjAgNDAgMjAiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIzIi8+PC9zdmc+" alt="呼吸練習遊戲" class="w-full h-40 object-cover">
                        <div class="p-5">
                            <h3 class="text-xl font-bold text-primary dark:text-blue-300 mb-2">呼吸練習遊戲</h3>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">跟隨動畫進行深呼吸練習，幫助放鬆並降低焦慮</p>
                            <button id="startBreathingGame" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition">
                                開始遊戲
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-secondary dark:bg-blue-900 rounded-2xl overflow-hidden shadow-md md:col-span-2">
                        <div class="w-full h-40 bg-gradient-to-r from-green-400 to-blue-400 flex items-center justify-center">
                            <div class="grid grid-cols-3 gap-3 p-3">
                                <div class="w-16 h-16 bg-white rounded-lg flex items-center justify-center">
                                    <svg class="w-10 h-10 text-primary" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="w-16 h-16 bg-white rounded-lg flex items-center justify-center">
                                    <svg class="w-10 h-10 text-purple-500" viewBox="0 0 24 24">
                                        <rect x="4" y="4" width="16" height="16" fill="currentColor"/>
                                    </svg>
                                </div>
                                <div class="w-16 h-16 bg-white rounded-lg flex items-center justify-center">
                                    <svg class="w-10 h-10 text-yellow-500" viewBox="0 0 24 24">
                                        <polygon points="12,2 22,22 2,22" fill="currentColor"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="p-5">
                            <h3 class="text-xl font-bold text-primary dark:text-blue-300 mb-2">形狀匹配遊戲</h3>
                            <p class="text-gray-600 dark:text-gray-300 mb-4">點擊與目標形狀相同的卡片，訓練視覺辨識能力</p>
                            <button id="startShapeGame" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition">
                                開始遊戲
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 顏色配對遊戲頁面 -->
        <div id="colorGamePage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="colorGameBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">顏色配對遊戲</h2>
                    <div class="ml-auto flex items-center">
                        <span class="text-lg font-bold mr-2">得分：</span>
                        <span id="colorGameScore" class="text-xl font-bold text-primary dark:text-blue-300">0</span>
                    </div>
                </div>
                
                <div class="mb-8 text-center">
                    <p class="text-lg mb-4">點擊與目標顏色相同的方塊</p>
                    <div id="targetColorContainer" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <p class="text-gray-600 dark:text-gray-300 mb-3">目標顏色：</p>
                        <div id="targetColor" class="target-color"></div>
                    </div>
                    <p id="gameStatus" class="text-lg text-green-500 mt-4 hidden">配對正確！</p>
                </div>
                
                <div id="colorGameGrid" class="grid grid-cols-3 gap-4 mb-6">
                    <!-- 顏色方塊將由 JavaScript 動態生成 -->
                </div>
                
                <div class="text-center">
                    <button id="startColorGameBtn" class="bg-primary text-white py-3 px-8 rounded-lg hover:bg-blue-400 transition text-lg">
                        開始遊戲
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 形狀匹配遊戲頁面 -->
        <div id="shapeGamePage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="shapeGameBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">形狀匹配遊戲</h2>
                    <div class="ml-auto flex items-center">
                        <span class="text-lg font-bold mr-2">得分：</span>
                        <span id="shapeGameScore" class="text-xl font-bold text-primary dark:text-blue-300">0</span>
                    </div>
                </div>
                
                <div class="mb-8 text-center">
                    <p class="text-lg mb-4">點擊與目標形狀相同的卡片</p>
                    <div id="targetShapeContainer" class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                        <p class="text-gray-600 dark:text-gray-300 mb-3">目標形狀：</p>
                        <div id="targetShape" class="w-20 h-20 mx-auto flex items-center justify-center">
                            <!-- 目標形狀將在這裡顯示 -->
                        </div>
                    </div>
                    <p id="shapeGameStatus" class="text-lg text-green-500 mt-4 hidden">匹配正確！</p>
                </div>
                
                <div id="shapeGameGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                    <!-- 形狀卡片將由 JavaScript 動態生成 -->
                </div>
                
                <div class="text-center">
                    <button id="startShapeGameBtn" class="bg-primary text-white py-3 px-8 rounded-lg hover:bg-blue-400 transition text-lg">
                        開始遊戲
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 呼吸練習遊戲頁面 -->
        <div id="breathingGamePage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="breathingGameBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">呼吸練習遊戲</h2>
                </div>
                
                <div class="mb-4 text-center">
                    <p id="breathingInstruction" class="text-xl font-bold text-primary dark:text-blue-300 mb-2">跟隨圓圈做深呼吸</p>
                    <p class="text-gray-600 dark:text-gray-300">這個練習可以幫助您放鬆身心</p>
                </div>
                
                <div class="flex justify-center items-center h-64 mb-8">
                    <div id="breathCircle" class="w-40 h-40 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center border-4 border-primary breath-circle">
                        <div class="w-32 h-32 bg-blue-200 dark:bg-blue-800 rounded-full flex items-center justify-center">
                            <div class="w-24 h-24 bg-blue-300 dark:bg-blue-700 rounded-full flex items-center justify-center">
                                <div class="w-16 h-16 bg-blue-400 dark:bg-blue-600 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="startBreathingExercise" class="bg-primary text-white py-3 px-8 rounded-lg hover:bg-blue-400 transition text-lg">
                        開始練習
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 設置頁面 -->
        <div id="settingsPage" class="page">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex items-center mb-6">
                    <button class="back-btn bg-gray-200 dark:bg-gray-700 p-2 rounded-lg mr-3" id="settingsBackBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-dark-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h2 class="text-2xl font-bold text-primary dark:text-blue-300">設置</h2>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">個人資料</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">姓名</label>
                            <input type="text" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入您的姓名">
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">年齡</label>
                            <input type="number" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入您的年齡">
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">性別</label>
                            <select class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base">
                                <option value="">請選擇</option>
                                <option value="male">男</option>
                                <option value="female">女</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">電話號碼</label>
                            <input type="tel" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入您的電話號碼">
                        </div>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">設備連接</h3>
                    <div class="space-y-4">
                        <button id="connectHeadphonesSettings" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.536a5 5 0 010-7.072m12.728 0l3.536-3.536M6.343 6.343l-.707-.707a1 1 0 00-1.414 1.414l.707.707m12.728 0l.707-.707a1 1 0 011.414 1.414l-.707.707M3 16V8a9 9 0 0118 0v8" />
                            </svg>
                            連接藍牙耳機
                        </button>
                        <button id="connectWatchSettings" class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-400 transition flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            連接智能手錶
                        </button>
                    </div>
                </div>
                
                <div class="mb-8">
                    <h3 class="text-xl font-semibold mb-4">緊急聯絡人</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">聯絡人姓名</label>
                            <input type="text" id="emergencyContactName" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入聯絡人姓名">
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">聯絡人電話</label>
                            <input type="tel" id="emergencyContactPhone" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入聯絡人電話">
                        </div>
                        <div>
                            <label class="block text-gray-700 dark:text-gray-300 mb-2">關係</label>
                            <input type="text" id="emergencyContactRelation" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 dark:text-white text-base" placeholder="請輸入您與聯絡人的關係">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-xl font-semibold mb-4">APP 設置</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <span class="text-lg">深色模式</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <span class="text-lg">通知</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>
                        <div class="flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <span class="text-lg">位置服務</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" checked class="sr-only peer">
                                <div class="w-14 h-7 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 檢測深色模式偏好
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
            document.getElementById('darkModeToggle').checked = true;
        }

        // 監聽深色模式變化
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeToggle').checked = true;
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeToggle').checked = false;
            }
        });

        // 深色模式切換
        document.getElementById('darkModeToggle').addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 獲取所有頁面
        const pages = {
            main: document.getElementById('mainPage'),
            music: document.getElementById('musicPage'),
            emotion: document.getElementById('emotionPage'),
            restaurant: document.getElementById('restaurantPage'),
            restaurantDetail: document.getElementById('restaurantDetailPage'),
            games: document.getElementById('gamesPage'),
            colorGame: document.getElementById('colorGamePage'),
            shapeGame: document.getElementById('shapeGamePage'),
            breathingGame: document.getElementById('breathingGamePage'),
            settings: document.getElementById('settingsPage')
        };
        
        // 獲取所有按鈕
        const buttons = {
            music: document.getElementById('musicBtn'),
            emotion: document.getElementById('emotionBtn'),
            restaurant: document.getElementById('restaurantBtn'),
            games: document.getElementById('gamesBtn'),
            settings: document.getElementById('settingsBtn')
        };
        
        // 獲取所有返回按鈕
        const backButtons = {
            music: document.getElementById('musicBackBtn'),
            emotion: document.getElementById('emotionBackBtn'),
            restaurant: document.getElementById('restaurantBackBtn'),
            restaurantDetail: document.getElementById('restaurantDetailBackBtn'),
            games: document.getElementById('gamesBackBtn'),
            colorGame: document.getElementById('colorGameBackBtn'),
            shapeGame: document.getElementById('shapeGameBackBtn'),
            breathingGame: document.getElementById('breathingGameBackBtn'),
            settings: document.getElementById('settingsBackBtn')
        };
        
        // 顯示特定頁面，隱藏其他頁面
        function showPage(pageName) {
            Object.keys(pages).forEach(key => {
                if (key === pageName) {
                    pages[key].classList.add('active');
                } else {
                    pages[key].classList.remove('active');
                }
            });
            
            // 滾動到頁面頂部
            window.scrollTo(0, 0);
        }
        
        // 設置主按鈕點擊事件
        Object.keys(buttons).forEach(key => {
            buttons[key].addEventListener('click', () => {
                showPage(key);
            });
        });
        
        // 設置返回按鈕點擊事件
        Object.keys(backButtons).forEach(key => {
            if (key === 'colorGame' || key === 'shapeGame' || key === 'breathingGame') {
                backButtons[key].addEventListener('click', () => {
                    showPage('games');
                });
            } else if (key === 'restaurantDetail') {
                backButtons[key].addEventListener('click', () => {
                    showPage('restaurant');
                });
            } else {
                backButtons[key].addEventListener('click', () => {
                    showPage('main');
                });
            }
        });
        
        // 設置遊戲選擇按鈕
        document.getElementById('startColorGame').addEventListener('click', () => {
            showPage('colorGame');
            createColorGame();
        });
        
        document.getElementById('startShapeGame').addEventListener('click', () => {
            showPage('shapeGame');
            initShapeGame();
        });
        
        document.getElementById('startBreathingGame').addEventListener('click', () => {
            showPage('breathingGame');
        });

        // 情緒穩定度與波動追蹤
        let emotionalStability = 100; // 0-100, 100 表示完全穩定
        let unstableTimeStart = null; // 情緒不穩定的開始時間
        const UNSTABLE_THRESHOLD = 70; // 低於此閾值被視為情緒不穩定
        const SEVERE_THRESHOLD = 40; // 低於此閾值被視為嚴重情緒不穩定
        const EMERGENCY_CONTACT_DELAY = 30000; // 30秒持續不穩定時聯絡緊急聯絡人
        const AUTO_PLAY_MUSIC_DELAY = 5000; // 5秒持續不穩定時播放音樂
        
        let contactedEmergency = false; // 是否已聯絡緊急聯絡人
        let autoMusicPlayed = false; // 是否已自動播放音樂
        
        // 模擬心跳數據
        function simulateHeartRate() {
            const heartRateEl = document.getElementById('heartRate');
            let rate = parseInt(heartRateEl.textContent);
            
            // 隨機波動
            const change = Math.floor(Math.random() * 5) - 2;
            rate += change;
            
            // 保持在合理範圍
            if (rate < 70) rate = 70;
            if (rate > 80) rate = 80;
            
            heartRateEl.textContent = rate;
            
            // 情緒波動模擬 (每隔一段時間)
            if (Math.random() < 0.05) {
                // 模擬情緒波動
                rate = Math.floor(Math.random() * 30) + 85;
                heartRateEl.textContent = rate;
                
                // 降低情緒穩定度
                emotionalStability = Math.max(20, emotionalStability - Math.floor(Math.random() * 40) - 20);
                
                // 檢查情緒不穩定
                checkEmotionalInstability();
            } else {
                // 逐漸恢復情緒穩定度
                emotionalStability = Math.min(100, emotionalStability + 1);
                
                // 如果恢復穩定，重置不穩定計時
                if (emotionalStability > UNSTABLE_THRESHOLD) {
                    unstableTimeStart = null;
                    contactedEmergency = false;
                    autoMusicPlayed = false;
                }
            }
            
            setTimeout(simulateHeartRate, 2000);
        }
        
        // 檢查情緒不穩定狀態並採取行動
        function checkEmotionalInstability() {
            // 如果情緒降至不穩定閾值以下
            if (emotionalStability < UNSTABLE_THRESHOLD) {
                // 如果這是剛開始不穩定，記錄時間
                if (unstableTimeStart === null) {
                    unstableTimeStart = Date.now();
                }
                
                const unstableDuration = Date.now() - unstableTimeStart;
                
                // 自動播放音樂
                if (!autoMusicPlayed && document.getElementById('autoPlayMusic').checked && unstableDuration > AUTO_PLAY_MUSIC_DELAY) {
                    autoPlayMusic();
                    autoMusicPlayed = true;
                }
                
                // 情緒嚴重不穩定且持續超過指定時間
                if (!contactedEmergency && document.getElementById('contactEmergency').checked && 
                    emotionalStability < SEVERE_THRESHOLD && unstableDuration > EMERGENCY_CONTACT_DELAY) {
                    contactEmergencyPerson();
                    contactedEmergency = true;
                }
            }
        }
        
        // 自動播放音樂功能
        function autoPlayMusic() {
            // 顯示通知
            const notification = document.createElement('div');
            notification.className = 'fixed bottom-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 flex items-center';
            notification.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                檢測到情緒波動，正在播放舒緩音樂
            `;
            document.body.appendChild(notification);
            
            // 3秒後移除通知
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
            
            // 自動跳轉到音樂頁面
            setTimeout(() => {
                showPage('music');
                
                // 播放用戶上傳的音樂（如果有）或者默認音樂
                if (userUploadedFiles.length > 0) {
                    playUserMusic(0);
                } else {
                    // 播放默認音樂
                    loadAudio(audioFiles[0].url, audioFiles[0].name);
                }
            }, 1500);
        }
        
        // 聯絡緊急聯絡人功能
        function contactEmergencyPerson() {
            // 獲取緊急聯絡人信息
            const contactName = document.getElementById('emergencyContactName').value || "緊急聯絡人";
            const contactPhone = document.getElementById('emergencyContactPhone').value || "未設置";
            
            // 顯示聯絡通知
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 flex items-center';
            notification.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" />
                </svg>
                正在聯絡${contactName}(${contactPhone})...
            `;
            document.body.appendChild(notification);
            
            // 5秒後移除通知
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
        
        // 啟動心跳模擬
        simulateHeartRate();
        
        // 連接設備的模擬功能
        document.getElementById('connectHeadphones').addEventListener('click', function() {
            const statusEl = document.getElementById('headphoneStatus');
            statusEl.textContent = '連接中...';
            
            setTimeout(() => {
                statusEl.textContent = '已連接 - Noise Cancelling Headphones';
                this.textContent = '斷開連接';
            }, 1500);
        });
        
        document.getElementById('connectWatch').addEventListener('click', function() {
            const statusEl = document.getElementById('watchStatus');
            statusEl.textContent = '連接中...';
            
            setTimeout(() => {
                statusEl.textContent = '已連接 - Smart Watch XYZ';
                this.textContent = '斷開連接';
            }, 1500);
        });
        
        // 設置頁面中的連接按鈕也進行相同操作
        document.getElementById('connectHeadphonesSettings').addEventListener('click', function() {
            document.getElementById('connectHeadphones').click();
            
            const statusEl = document.getElementById('headphoneStatus');
            if (statusEl.textContent === '未連接') {
                this.textContent = '連接藍牙耳機';
            } else {
                this.textContent = '斷開藍牙耳機';
            }
        });
        
        document.getElementById('connectWatchSettings').addEventListener('click', function() {
            document.getElementById('connectWatch').click();
            
            const statusEl = document.getElementById('watchStatus');
            if (statusEl.textContent === '未連接') {
                this.textContent = '連接智能手錶';
            } else {
                this.textContent = '斷開智能手錶';
            }
        });
        
        // 用戶音樂上傳功能
        const userUploadedFiles = [];
        
        document.getElementById('musicUpload').addEventListener('change', function(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // 只接受 MP3 文件
                if (file.type !== 'audio/mp3' && !file.name.endsWith('.mp3')) {
                    alert(`${file.name} 不是有效的 MP3 文件。`);
                    continue;
                }
                
                // 創建文件 URL
                const fileUrl = URL.createObjectURL(file);
                
                // 保存文件信息
                userUploadedFiles.push({
                    name: file.name,
                    url: fileUrl,
                    isUserFile: true
                });
                
                // 更新已上傳文件顯示
                updateUploadedFilesList();
                
                // 更新播放列表
                updateUserPlaylist();
            }
            
            // 清除文件選擇，允許再次選擇相同文件
            this.value = '';
        });
        
        // 更新已上傳文件列表
        function updateUploadedFilesList() {
            const container = document.getElementById('uploadedFiles');
            container.innerHTML = '';
            
            if (userUploadedFiles.length === 0) {
                return;
            }
            
            userUploadedFiles.forEach((file, index) => {
                const fileEl = document.createElement('div');
                fileEl.className = 'uploaded-file';
                fileEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                    <span class="flex-1 truncate">${file.name}</span>
                    <button class="text-red-500 hover:text-red-700 p-1" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                container.appendChild(fileEl);
                
                // 添加刪除按鈕事件
                const deleteBtn = fileEl.querySelector('button');
                deleteBtn.addEventListener('click', function() {
                    const fileIndex = parseInt(this.dataset.index);
                    // 釋放文件 URL 對象
                    URL.revokeObjectURL(userUploadedFiles[fileIndex].url);
                    // 從列表中移除
                    userUploadedFiles.splice(fileIndex, 1);
                    // 更新顯示
                    updateUploadedFilesList();
                    updateUserPlaylist();
                });
            });
        }
        
        // 更新用戶播放列表
        function updateUserPlaylist() {
            const container = document.getElementById('userPlaylistItems');
            container.innerHTML = '';
            
            if (userUploadedFiles.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">尚未上傳音樂</p>';
                return;
            }
            
            userUploadedFiles.forEach((file, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'playlist-item';
                itemEl.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                    </svg>
                    <span class="flex-1 truncate">${file.name}</span>
                    <button class="text-primary p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        </svg>
                    </button>
                `;
                
                container.appendChild(itemEl);
                
                // 添加播放按鈕事件
                itemEl.addEventListener('click', function() {
                    playUserMusic(index);
                });
            });
        }
        
        // 播放用戶音樂
        function playUserMusic(index) {
            if (index >= 0 && index < userUploadedFiles.length) {
                const file = userUploadedFiles[index];
                loadAudio(file.url, file.name);
            }
        }
        
        // 音訊處理相關功能
        const audioPlayer = document.getElementById('audioPlayer');
        const volumeControl = document.getElementById('volumeControl');
        const pitchControl = document.getElementById('pitchControl');
        const speedControl = document.getElementById('speedControl');
        const playPauseButton = document.getElementById('playPauseButton');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const loopButton = document.getElementById('loopButton');
        const shuffleButton = document.getElementById('shuffleButton');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const nowPlayingTitle = document.getElementById('nowPlayingTitle');
        const nowPlayingTime = document.getElementById('nowPlayingTime');
        const audioVisualizer = document.getElementById('audioVisualizer');
        
        // 音頻文件列表
        const audioFiles = [
            { name: "輕鬆音樂", url: "https://pfst.cf2.poecdn.net/base/audio/30816ad23d2cb85a2a1a58bd63bc78118444d0c9c45289630d8235418286b7bd" },
            { name: "自然聲音", url: "https://pfst.cf2.poecdn.net/base/audio/24916ca12e20fbfb99f4c9cfc189dbdadd8e60489d9070c3d73c65de9f8db3fa" },
            { name: "白噪音", url: "https://pfst.cf2.poecdn.net/base/audio/85d66c040d1f9cefd01eb1883670b611ca6b632582eb386e1085fd01630fee43" },
            { name: "粉紅噪音", url: "https://pfst.cf2.poecdn.net/base/audio/14e77731250f352c18ce908ead88e75341a92767a874dd748f3f228dd621297e" }
        ];
        
        let currentAudioIndex = 0;
        let isPlaying = false;
        let isLooping = false;
        let isShuffle = false;
        let audioContext = null;
        let sourceNode = null;
        let gainNode = null;
        let isUserMusic = false; // 是否正在播放用戶上傳的音樂
        
        // 初始化音頻播放器
        function initAudioPlayer() {
            // 設置默認音量
            audioPlayer.volume = volumeControl.value / 100;
            
            // 音頻播放控制
            playPauseButton.addEventListener('click', togglePlayPause);
            
            // 進度條點擊事件
            progressBar.addEventListener('click', function(e) {
                if (audioPlayer.src) {
                    const percent = e.offsetX / this.offsetWidth;
                    audioPlayer.currentTime = percent * audioPlayer.duration;
                    progressFill.style.width = `${percent * 100}%`;
                }
            });
            
            // 音量控制
            volumeControl.addEventListener('input', function() {
                audioPlayer.volume = this.value / 100;
            });
            
            // 音頻事件監聽
            audioPlayer.addEventListener('timeupdate', updateProgress);
            audioPlayer.addEventListener('ended', handleAudioEnd);
            
            // 檢查音頻上下文是否可用
            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
            } catch (e) {
                console.log('Web Audio API 不支援');
            }
            
            // 前一首與下一首按鈕
            prevButton.addEventListener('click', playPrevious);
            nextButton.addEventListener('click', playNext);
            
            // 循環和隨機播放按鈕
            loopButton.addEventListener('click', toggleLoop);
            shuffleButton.addEventListener('click', toggleShuffle);
            
            // 添加音效調節功能
            pitchControl.addEventListener('input', applyAudioEffects);
            speedControl.addEventListener('input', function() {
                audioPlayer.playbackRate = parseFloat(this.value);
            });
        }
        
        // 切換播放/暫停狀態
        function togglePlayPause() {
            if (!audioPlayer.src) {
                // 如果沒有選擇音頻，默認播放第一個
                loadAudio(audioFiles[0].url, audioFiles[0].name);
            }
            
            if (isPlaying) {
                audioPlayer.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                isPlaying = false;
                audioVisualizer.classList.remove('animate-pulse');
            } else {
                audioPlayer.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                isPlaying = true;
                audioVisualizer.classList.add('animate-pulse');
            }
        }
        
        // 更新進度條
        function updateProgress() {
            const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressFill.style.width = `${percent}%`;
            
            // 更新時間顯示
            const currentMinutes = Math.floor(audioPlayer.currentTime / 60);
            const currentSeconds = Math.floor(audioPlayer.currentTime % 60);
            const durationMinutes = Math.floor(audioPlayer.duration / 60) || 0;
            const durationSeconds = Math.floor(audioPlayer.duration % 60) || 0;
            
            nowPlayingTime.textContent = `${currentMinutes}:${currentSeconds.toString().padStart(2, '0')} / ${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
        }
        
        // 處理音頻結束事件
        function handleAudioEnd() {
            if (isLooping) {
                // 循環播放當前歌曲
                audioPlayer.currentTime = 0;
                audioPlayer.play();
            } else if (isShuffle) {
                // 隨機播放
                if (isUserMusic && userUploadedFiles.length > 0) {
                    // 從用戶上傳的音樂中隨機播放
                    const randomIndex = Math.floor(Math.random() * userUploadedFiles.length);
                    playUserMusic(randomIndex);
                } else if (!isUserMusic && audioFiles.length > 0) {
                    // 從預設音樂中隨機播放
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * audioFiles.length);
                    } while (randomIndex === currentAudioIndex && audioFiles.length > 1);
                    
                    currentAudioIndex = randomIndex;
                    loadAudio(audioFiles[currentAudioIndex].url, audioFiles[currentAudioIndex].name);
                }
            } else {
                // 播放下一首
                playNext();
            }
        }
        
        // 播放前一首
        function playPrevious() {
            if (isUserMusic && userUploadedFiles.length > 0) {
                // 用戶音樂
                const currentIndex = userUploadedFiles.findIndex(file => file.url === audioPlayer.src);
                const prevIndex = (currentIndex > 0) ? currentIndex - 1 : userUploadedFiles.length - 1;
                playUserMusic(prevIndex);
            } else {
                // 預設音樂
                currentAudioIndex = (currentAudioIndex - 1 + audioFiles.length) % audioFiles.length;
                loadAudio(audioFiles[currentAudioIndex].url, audioFiles[currentAudioIndex].name);
            }
        }
        
        // 播放下一首
        function playNext() {
            if (isUserMusic && userUploadedFiles.length > 0) {
                // 用戶音樂
                const currentIndex = userUploadedFiles.findIndex(file => file.url === audioPlayer.src);
                const nextIndex = (currentIndex < userUploadedFiles.length - 1) ? currentIndex + 1 : 0;
                playUserMusic(nextIndex);
            } else {
                // 預設音樂
                currentAudioIndex = (currentAudioIndex + 1) % audioFiles.length;
                loadAudio(audioFiles[currentAudioIndex].url, audioFiles[currentAudioIndex].name);
            }
        }
        
        // 切換循環狀態
        function toggleLoop() {
            isLooping = !isLooping;
            loopButton.classList.toggle('text-primary');
            loopButton.classList.toggle('dark:text-dark-primary');
        }
        
        // 切換隨機播放狀態
        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleButton.classList.toggle('text-primary');
            shuffleButton.classList.toggle('dark:text-dark-primary');
        }
        
        // 加載音頻
        function loadAudio(url, title) {
            // 檢查是否為用戶音樂
            isUserMusic = userUploadedFiles.some(file => file.url === url);
            
            audioPlayer.src = url;
            nowPlayingTitle.textContent = title;
            
            // 重置進度條
            progressFill.style.width = '0%';
            
            // 自動播放
            audioPlayer.play()
                .then(() => {
                    isPlaying = true;
                    playIcon.classList.add('hidden');
                    pauseIcon.classList.remove('hidden');
                    audioVisualizer.classList.add('animate-pulse');
                })
                .catch(err => {
                    console.log('播放失敗:', err);
                    isPlaying = false;
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                });
        }
        
        // 應用音頻效果
        function applyAudioEffects() {
            // Web Audio API 目前不支援直接修改音調，這裡只是模擬效果
            if (pitchControl.value != 0) {
                audioVisualizer.style.transform = `scale(${1 + parseInt(pitchControl.value) / 20})`;
            } else {
                audioVisualizer.style.transform = '';
            }
        }
        
        // 選擇音樂類型
        document.querySelectorAll('.music-type').forEach((btn, index) => {
            btn.addEventListener('click', function() {
                // 移除其他選中狀態
                document.querySelectorAll('.music-type').forEach(b => {
                    b.classList.remove('active', 'bg-primary', 'text-white');
                    b.classList.add('bg-secondary', 'dark:bg-blue-900');
                });
                
                // 添加選中狀態
                this.classList.remove('bg-secondary', 'dark:bg-blue-900');
                this.classList.add('active');
                
                // 播放選中的音樂
                const soundUrl = this.dataset.sound;
                const soundName = this.textContent.trim();
                
                // 找到對應的索引
                const fileIndex = audioFiles.findIndex(file => file.url === soundUrl);
                if (fileIndex !== -1) {
                    currentAudioIndex = fileIndex;
                    loadAudio(soundUrl, soundName);
                }
            });
        });
        
        // 餐廳數據和功能
        const restaurants = [
            {
                id: 1,
                name: "寧靜咖啡屋",
                address: "旺角彌敦道610號",
                location: { lat: 22.3186, lng: 114.1701 },
                distance: "5分鐘",
                features: ["低噪音環境", "專業培訓員工"],
                description: "寧靜咖啡屋提供一個安靜舒適的環境，服務員經過專業培訓，了解如何為自閉症患者提供適當的服務。",
                phone: "2345-6789",
                hours: "週一至週日: 08:00 - 21:00",
                branches: ["銅鑼灣", "尖沙咀", "元朗"]
            },
            {
                id: 2,
                name: "和諧餐廳",
                address: "旺角花園街123號",
                location: { lat: 22.3167, lng: 114.1735 },
                distance: "7分鐘",
                features: ["安靜區域", "視覺菜單"],
                description: "和諧餐廳設有特別的安靜區域，並且提供視覺菜單，方便自閉症患者點餐和享用餐點。",
                phone: "3456-7890",
                hours: "週一至週日: 11:00 - 22:00",
                branches: ["沙田", "太古"]
            },
            {
                id: 3,
                name: "友善食坊",
                address: "旺角西洋菜南街456號",
                location: { lat: 22.3178, lng: 114.1693 },
                distance: "10分鐘",
                features: ["無障礙設施", "無麩質選項"],
                description: "友善食坊特別為有特殊需求的顧客設計，提供無障礙設施和多種無麩質食品選擇。",
                phone: "4567-8901",
                hours: "週二至週日: 10:00 - 20:00",
                branches: ["觀塘", "將軍澳"]
            }
        ];
        
        // 用戶收藏的餐廳
        let favoriteRestaurants = [];
        
        // 推薦的餐廳
        let recommendedRestaurants = [
            {
                id: 101,
                name: "靜謐茶館",
                address: "中環皇后大道10號",
                features: ["低光環境", "隔音設計"],
                added: false
            },
            {
                id: 102,
                name: "特色素食餐廳",
                address: "尖沙咀廣東道88號",
                features: ["特殊飲食選項", "安靜環境"],
                added: false
            },
            {
                id: 103,
                name: "家庭友善餐廳",
                address: "銅鑼灣怡和街33號",
                features: ["兒童友善", "明確的視覺指引"],
                added: false
            }
        ];
        
        // 初始化餐廳功能
        function initRestaurantFeatures() {
            // 渲染餐廳列表
            renderRestaurantsList();
            
            // 渲染收藏餐廳
            renderFavoriteRestaurants();
            
            // 渲染推薦餐廳
            renderRecommendedRestaurants();
            
            // 添加監護人模式切換
            document.getElementById('toggleGuardianMode').addEventListener('click', function() {
                const panel = document.getElementById('guardianModePanel');
                if (panel.classList.contains('hidden')) {
                    panel.classList.remove('hidden');
                    this.textContent = '退出監護人模式';
                } else {
                    panel.classList.add('hidden');
                    this.textContent = '進入監護人模式';
                }
            });
            
            // 添加新餐廳
            document.getElementById('addRestaurantBtn').addEventListener('click', function() {
                const restaurantName = document.getElementById('newRestaurantName').value.trim();
                if (!restaurantName) {
                    alert('請輸入餐廳名稱');
                    return;
                }
                
                // 檢查是否已存在
                if (favoriteRestaurants.some(r => r.name === restaurantName)) {
                    alert('此餐廳已在收藏列表中');
                    return;
                }
                
                // 添加到收藏
                const newRestaurant = {
                    id: Date.now(),
                    name: restaurantName,
                    address: "自定義地址",
                    branches: []
                };
                
                favoriteRestaurants.push(newRestaurant);
                renderFavoriteRestaurants();
                
                // 清空輸入框
                document.getElementById('newRestaurantName').value = '';
                
                // 生成推薦（模擬）
                generateRecommendations(newRestaurant.name);
            });
            
            // 搜尋餐廳
            document.getElementById('searchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('searchRestaurant').value.trim().toLowerCase();
                if (!searchTerm) return;
                
                const allRestaurants = [...restaurants, ...favoriteRestaurants];
                const found = allRestaurants.find(r => r.name.toLowerCase().includes(searchTerm));
                
                if (found) {
                    showRestaurantDetail(found);
                } else {
                    alert('找不到符合的餐廳');
                }
            });
        }
        
        // 渲染餐廳列表
        function renderRestaurantsList() {
            const container = document.getElementById('restaurantsList');
            container.innerHTML = '';
            
            // 渲染所有餐廳
            const allRestaurants = [...restaurants, ...favoriteRestaurants.filter(fr => 
                !restaurants.some(r => r.name === fr.name)
            )];
            
            // 根據當前位置篩選餐廳（模擬）
            const currentLocation = document.getElementById('currentLocation').textContent;
            const filteredRestaurants = allRestaurants.filter(r => {
                // 檢查是否有分店在當前位置
                if (r.branches && r.branches.some(b => currentLocation.includes(b))) {
                    return true;
                }
                // 或者餐廳本身在當前位置
                return r.address.includes(currentLocation) || currentLocation.includes(r.address);
            });
            
            if (filteredRestaurants.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-4">附近沒有發現友善餐廳</p>';
                return;
            }
            
            // 渲染餐廳卡片
            filteredRestaurants.forEach(restaurant => {
                const card = document.createElement('div');
                card.className = 'restaurant-card bg-secondary dark:bg-blue-900 rounded-lg p-5 shadow-md';
                card.innerHTML = `
                    <h4 class="font-semibold text-lg">${restaurant.name}</h4>
                    <p class="text-gray-600 dark:text-gray-300">${restaurant.address || '詳細地址未提供'} - ${restaurant.distance || '距離未知'}</p>
                    <div class="flex mt-3 flex-wrap">
                        ${(restaurant.features || []).map(feature => 
                            `<span class="bg-green-100 text-green-800 text-sm px-2 py-1 rounded dark:bg-green-900 dark:text-green-200 mr-2 mb-2">${feature}</span>`
                        ).join('')}
                    </div>
                    <button class="mt-3 bg-primary text-white py-2 px-4 rounded-lg w-full hover:bg-blue-400 transition">
                        查看詳情
                    </button>
                `;
                
                container.appendChild(card);
                
                // 添加點擊事件
                card.querySelector('button').addEventListener('click', () => {
                    showRestaurantDetail(restaurant);
                });
                
                // 添加餐廳標記到地圖
                if (restaurant.location) {
                    addRestaurantMarker(restaurant);
                }
            });
        }
        
        // 添加餐廳標記到地圖
        function addRestaurantMarker(restaurant) {
            if (!restaurant.location) return;
            
            const map = document.getElementById('map');
            const mapWidth = map.clientWidth;
            const mapHeight = map.clientHeight;
            
            // 計算模擬位置（實際應用中應使用真實經緯度轉換）
            const x = mapWidth * (0.3 + Math.random() * 0.4); // 隨機位置
            const y = mapHeight * (0.3 + Math.random() * 0.4); // 隨機位置
            
            const marker = document.createElement('div');
            marker.className = 'map-marker';
            marker.style.left = `${x}px`;
            marker.style.top = `${y}px`;
            marker.setAttribute('data-restaurant-id', restaurant.id);
            
            map.appendChild(marker);
            
            // 添加點擊事件
            marker.addEventListener('click', () => {
                showRestaurantDetail(restaurant);
            });
        }
        
        // 顯示餐廳詳情
        function showRestaurantDetail(restaurant) {
            // 填充餐廳詳情
            document.getElementById('restaurantDetailName').textContent = restaurant.name;
            document.getElementById('restaurantDetailAddress').textContent = restaurant.address || '地址未提供';
            document.getElementById('restaurantDetailHours').textContent = restaurant.hours || '營業時間未提供';
            document.getElementById('restaurantDetailPhone').textContent = restaurant.phone || '電話未提供';
            
            // 清空並填充特點標籤
            const featuresContainer = document.getElementById('restaurantDetailFeatures');
            featuresContainer.innerHTML = '';
            
            if (restaurant.features && restaurant.features.length > 0) {
                restaurant.features.forEach(feature => {
                    const featureTag = document.createElement('span');
                    featureTag.className = 'bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-200';
                    featureTag.textContent = feature;
                    featuresContainer.appendChild(featureTag);
                });
            } else {
                featuresContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">沒有特點資訊</p>';
            }
            
            // 設置餐廳描述
            document.getElementById('restaurantDetailDescription').textContent = restaurant.description || '沒有詳細描述';
            
            // 設置操作按鈕
            const callBtn = document.getElementById('restaurantCallBtn');
            const navigateBtn = document.getElementById('restaurantNavigateBtn');
            
            callBtn.onclick = () => {
                if (restaurant.phone) {
                    alert(`準備撥打電話至: ${restaurant.phone}`);
                } else {
                    alert('沒有提供電話號碼');
                }
            };
            
            navigateBtn.onclick = () => {
                alert(`準備導航至: ${restaurant.name} (${restaurant.address})`);
            };
            
            // 顯示詳情頁面
            showPage('restaurantDetail');
        }
        
        // 渲染收藏餐廳列表
        function renderFavoriteRestaurants() {
            const container = document.getElementById('favoriteRestaurants');
            container.innerHTML = '';
            
            if (favoriteRestaurants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">尚未添加常去餐廳</p>';
                return;
            }
            
            favoriteRestaurants.forEach((restaurant, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-lg';
                item.innerHTML = `
                    <span class="flex-1">${restaurant.name}</span>
                    <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-1 add-branch-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                    <button class="text-red-500 hover:text-red-700 p-1 remove-restaurant-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                container.appendChild(item);
                
                // 添加刪除按鈕事件
                item.querySelector('.remove-restaurant-btn').addEventListener('click', function() {
                    const restaurantIndex = parseInt(this.dataset.index);
                    favoriteRestaurants.splice(restaurantIndex, 1);
                    renderFavoriteRestaurants();
                    renderRestaurantsList();
                });
                
                // 添加分店按鈕事件
                item.querySelector('.add-branch-btn').addEventListener('click', function() {
                    const restaurantIndex = parseInt(this.dataset.index);
                    const branch = prompt('請輸入分店地區 (例如: 旺角, 銅鑼灣)');
                    
                    if (branch && branch.trim()) {
                        if (!favoriteRestaurants[restaurantIndex].branches) {
                            favoriteRestaurants[restaurantIndex].branches = [];
                        }
                        
                        favoriteRestaurants[restaurantIndex].branches.push(branch.trim());
                        alert(`已添加 ${favoriteRestaurants[restaurantIndex].name} 的 ${branch.trim()} 分店`);
                        renderRestaurantsList();
                    }
                });
                
                // 顯示分店（如果有）
                if (restaurant.branches && restaurant.branches.length > 0) {
                    const branchesContainer = document.createElement('div');
                    branchesContainer.className = 'mt-1 ml-4 space-y-1';
                    
                    restaurant.branches.forEach(branch => {
                        const branchItem = document.createElement('div');
                        branchItem.className = 'flex items-center text-sm text-gray-500 dark:text-gray-400';
                        branchItem.innerHTML = `
                            <span class="mr-1">•</span>
                            <span>${branch}</span>
                        `;
                        branchesContainer.appendChild(branchItem);
                    });
                    
                    item.insertAdjacentElement('afterend', branchesContainer);
                }
            });
        }
        
        // 渲染推薦餐廳
        function renderRecommendedRestaurants() {
            const container = document.getElementById('recommendedRestaurants');
            container.innerHTML = '';
            
            if (recommendedRestaurants.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">沒有推薦餐廳</p>';
                return;
            }
            
            // 只顯示未被添加的推薦
            const filteredRecommendations = recommendedRestaurants.filter(r => !r.added);
            
            if (filteredRecommendations.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm text-center py-2">沒有新的推薦餐廳</p>';
                return;
            }
            
            filteredRecommendations.forEach((restaurant, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-50 dark:bg-gray-700 p-2 rounded-lg';
                item.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium">${restaurant.name}</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">${restaurant.address}</div>
                        <div class="flex mt-1 flex-wrap">
                            ${(restaurant.features || []).map(feature => 
                                `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full dark:bg-blue-900 dark:text-blue-200 mr-2 mb-1">${feature}</span>`
                            ).join('')}
                        </div>
                    </div>
                    <button class="text-primary hover:text-blue-700 p-1 add-recommendation-btn" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                    </button>
                `;
                
                container.appendChild(item);
                
                // 添加按鈕事件
                item.querySelector('.add-recommendation-btn').addEventListener('click', function() {
                    const recommendationIndex = parseInt(this.dataset.index);
                    const recommendedRestaurant = recommendedRestaurants[recommendationIndex];
                    
                    // 標記為已添加
                    recommendedRestaurants[recommendationIndex].added = true;
                    
                    // 添加到收藏餐廳
                    favoriteRestaurants.push({
                        id: recommendedRestaurant.id,
                        name: recommendedRestaurant.name,
                        address: recommendedRestaurant.address,
                        features: recommendedRestaurant.features,
                        branches: []
                    });
                    
                    // 更新顯示
                    renderFavoriteRestaurants();
                    renderRecommendedRestaurants();
                    renderRestaurantsList();
                });
            });
        }
        
        // 生成餐廳推薦（模擬）
        function generateRecommendations(restaurantName) {
            // 模擬從服務器獲取推薦
            setTimeout(() => {
                // 生成一個新的推薦
                const newRecommendation = {
                    id: 100 + Math.floor(Math.random() * 900),
                    name: `${restaurantName}的相似餐廳`,
                    address: ["銅鑼灣", "尖沙咀", "中環", "旺角"][Math.floor(Math.random() * 4)] + "分店",
                    features: ["安靜環境", "無障礙設施", "特殊飲食選項", "友善員工"][Math.floor(Math.random() * 4)].split(),
                    added: false
                };
                
                recommendedRestaurants.push(newRecommendation);
                renderRecommendedRestaurants();
            }, 1000);
        }
        
        // 更新位置按鈕
        document.getElementById('refreshLocation').addEventListener('click', function() {
            const locations = ['旺角站', '銅鑼灣站', '中環站', '深水埗站', '九龍灣站'];
            const randomLocation = locations[Math.floor(Math.random() * locations.length)];
            document.getElementById('currentLocation').textContent = randomLocation;
            
            // 重新渲染餐廳列表
            renderRestaurantsList();
        });
        
        // 顏色配對遊戲功能
        let colorGameActive = false;
        let colorGameScore = 0;
        
        // 可用的顏色
        const gameColors = [
            { name: '紅色', hex: '#e74c3c' },
            { name: '藍色', hex: '#3498db' },
            { name: '綠色', hex: '#2ecc71' },
            { name: '黃色', hex: '#f1c40f' },
            { name: '紫色', hex: '#9b59b6' },
            { name: '橙色', hex: '#e67e22' },
            { name: '粉色', hex: '#e84393' },
            { name: '青色', hex: '#00cec9' },
            { name: '棕色', hex: '#d35400' }
        ];
        
        function createColorGame() {
            const grid = document.getElementById('colorGameGrid');
            grid.innerHTML = '';
            
            // 隨機選擇目標顏色
            const targetIndex = Math.floor(Math.random() * gameColors.length);
            const targetColor = gameColors[targetIndex];
            
            // 設置目標顏色
            const targetColorEl = document.getElementById('targetColor');
            targetColorEl.style.backgroundColor = targetColor.hex;
            
            // 隨機排列顏色
            const shuffledColors = [...gameColors];
            for (let i = shuffledColors.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledColors[i], shuffledColors[j]] = [shuffledColors[j], shuffledColors[i]];
            }
            
            // 創建顏色方塊
            shuffledColors.forEach(color => {
                const colorTile = document.createElement('button');
                colorTile.className = 'color-tile aspect-square';
                colorTile.style.backgroundColor = color.hex;
                
                colorTile.addEventListener('click', function(e) {
                    if (!colorGameActive) return;
                    
                    // 創建點擊波紋效果
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    this.appendChild(ripple);
                    
                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
                    ripple.style.top = `${e.clientY - rect.top - size/2}px`;
                    
                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                    
                    // 檢查是否匹配目標顏色
                    if (color.hex === targetColor.hex) {
                        colorGameScore++;
                        document.getElementById('colorGameScore').textContent = colorGameScore;
                        
                        // 顯示正確提示
                        const statusEl = document.getElementById('gameStatus');
                        statusEl.textContent = '配對正確！';
                        statusEl.classList.remove('hidden', 'text-red-500');
                        statusEl.classList.add('text-green-500');
                        statusEl.classList.remove('hidden');
                        
                        setTimeout(() => {
                            statusEl.classList.add('hidden');
                        }, 1000);
                        
                        // 重新創建遊戲
                        createColorGame();
                    } else {
                        // 顯示錯誤提示
                        const statusEl = document.getElementById('gameStatus');
                        statusEl.textContent = '配對錯誤！';
                        statusEl.classList.remove('hidden', 'text-green-500');
                        statusEl.classList.add('text-red-500');
                        statusEl.classList.remove('hidden');
                        
                        setTimeout(() => {
                            statusEl.classList.add('hidden');
                        }, 1000);
                    }
                });
                
                grid.appendChild(colorTile);
            });
        }
        
        function startColorGame() {
            // 重置遊戲
            colorGameScore = 0;
            document.getElementById('colorGameScore').textContent = '0';
            document.getElementById('gameStatus').classList.add('hidden');
            
            // 創建遊戲
            createColorGame();
            
            // 啟動遊戲
            colorGameActive = true;
            document.getElementById('startColorGameBtn').textContent = '重新開始';
        }
        
        // 設置顏色遊戲開始按鈕
        document.getElementById('startColorGameBtn').addEventListener('click', startColorGame);
        
        // 形狀匹配遊戲功能
        let shapeGameActive = false;
        let shapeGameScore = 0;
        
        // 可用的形狀
        const gameShapes = [
            { 
                name: '圓形', 
                svg: '<circle cx="50" cy="50" r="40" fill="currentColor"/>' 
            },
            { 
                name: '正方形', 
                svg: '<rect x="10" y="10" width="80" height="80" fill="currentColor"/>' 
            },
            { 
                name: '三角形', 
                svg: '<polygon points="50,10 90,90 10,90" fill="currentColor"/>' 
            },
            { 
                name: '星星', 
                svg: '<polygon points="50,10 61,35 90,35 65,55 75,80 50,65 25,80 35,55 10,35 39,35" fill="currentColor"/>' 
            },
            { 
                name: '心形', 
                svg: '<path d="M50,80 C80,60 100,10 50,30 C0,10 20,60 50,80" fill="currentColor"/>' 
            },
            { 
                name: '菱形', 
                svg: '<polygon points="50,10 90,50 50,90 10,50" fill="currentColor"/>' 
            }
        ];
        
        // 形狀的可能顏色
        const shapeColors = [
            '#e74c3c', // 紅色
            '#3498db', // 藍色
            '#2ecc71', // 綠色
            '#f1c40f', // 黃色
            '#9b59b6', // 紫色
            '#e67e22'  // 橙色
        ];
        
        function initShapeGame() {
            // 清空網格
            const grid = document.getElementById('shapeGameGrid');
            grid.innerHTML = '';
            
            // 隨機選擇目標形狀
            const targetIndex = Math.floor(Math.random() * gameShapes.length);
            const targetShape = gameShapes[targetIndex];
            
            // 設置目標形狀
            const targetShapeEl = document.getElementById('targetShape');
            targetShapeEl.innerHTML = `
                <svg viewBox="0 0 100 100" width="100%" height="100%" class="text-primary">
                    ${targetShape.svg}
                </svg>
            `;
            
            // 隨機排列形狀（包括不同顏色的目標形狀和其他形狀）
            let shapeCards = [];
            
            // 添加3個目標形狀（不同顏色）
            const targetColor = shapeColors[Math.floor(Math.random() * shapeColors.length)];
            for (let i = 0; i < 3; i++) {
                shapeCards.push({
                    shape: targetShape,
                    color: shapeColors[Math.floor(Math.random() * shapeColors.length)],
                    isTarget: true
                });
            }
            
            // 添加其他形狀
            for (let i = 0; i < 3; i++) {
                let shape;
                do {
                    shape = gameShapes[Math.floor(Math.random() * gameShapes.length)];
                } while (shape.name === targetShape.name);
                
                shapeCards.push({
                    shape: shape,
                    color: shapeColors[Math.floor(Math.random() * shapeColors.length)],
                    isTarget: false
                });
            }
            
            // 洗牌算法
            for (let i = shapeCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shapeCards[i], shapeCards[j]] = [shapeCards[j], shapeCards[i]];
            }
            
            // 創建形狀卡片
            shapeCards.forEach(card => {
                const shapeCard = document.createElement('div');
                shapeCard.className = 'shape-card bg-white dark:bg-gray-700 shadow-md';
                shapeCard.innerHTML = `
                    <div class="shape-container">
                        <svg viewBox="0 0 100 100" width="100%" height="100%" style="color: ${card.color};">
                            ${card.shape.svg}
                        </svg>
                    </div>
                `;
                
                shapeCard.addEventListener('click', function() {
                    if (!shapeGameActive) return;
                    
                    if (card.isTarget) {
                        // 正確匹配
                        shapeGameScore++;
                        document.getElementById('shapeGameScore').textContent = shapeGameScore;
                        
                        // 視覺反饋
                        this.classList.add('bg-green-100', 'dark:bg-green-900');
                        setTimeout(() => {
                            // 顯示成功訊息
                            const statusEl = document.getElementById('shapeGameStatus');
                            statusEl.textContent = '匹配正確！';
                            statusEl.classList.remove('hidden', 'text-red-500');
                            statusEl.classList.add('text-green-500');
                            statusEl.classList.remove('hidden');
                            
                            setTimeout(() => {
                                statusEl.classList.add('hidden');
                                // 重新初始化遊戲
                                initShapeGame();
                            }, 1000);
                        }, 300);
                    } else {
                        // 錯誤匹配
                        this.classList.add('bg-red-100', 'dark:bg-red-900');
                        setTimeout(() => {
                            this.classList.remove('bg-red-100', 'dark:bg-red-900');
                            
                            // 顯示錯誤訊息
                            const statusEl = document.getElementById('shapeGameStatus');
                            statusEl.textContent = '形狀不匹配！';
                            statusEl.classList.remove('hidden', 'text-green-500');
                            statusEl.classList.add('text-red-500');
                            statusEl.classList.remove('hidden');
                            
                            setTimeout(() => {
                                statusEl.classList.add('hidden');
                            }, 1000);
                        }, 300);
                    }
                });
                
                grid.appendChild(shapeCard);
            });
        }
        
        function startShapeGame() {
            // 重置遊戲
            shapeGameScore = 0;
            document.getElementById('shapeGameScore').textContent = '0';
            document.getElementById('shapeGameStatus').classList.add('hidden');
            
            // 初始化遊戲
            initShapeGame();
            
            // 啟動遊戲
            shapeGameActive = true;
            document.getElementById('startShapeGameBtn').textContent = '重新開始';
        }
        
        // 設置形狀遊戲開始按鈕
        document.getElementById('startShapeGameBtn').addEventListener('click', startShapeGame);
        
        // 呼吸練習遊戲功能
        let breathingInterval;
        let isBreathingActive = false;
        
        document.getElementById('startBreathingExercise').addEventListener('click', function() {
            const breathCircle = document.getElementById('breathCircle');
            const instruction = document.getElementById('breathingInstruction');
            
            if (isBreathingActive) {
                // 停止練習
                clearInterval(breathingInterval);
                this.textContent = '開始練習';
                instruction.textContent = '跟隨圓圈做深呼吸';
                breathCircle.classList.remove('breath-animation-inhale', 'breath-animation-hold', 'breath-animation-exhale');
                isBreathingActive = false;
            } else {
                // 開始練習
                this.textContent = '停止練習';
                isBreathingActive = true;
                
                let phase = 0; // 0: 吸氣, 1: 屏息, 2: 呼氣
                
                function updateBreathing() {
                    switch(phase) {
                        case 0: // 吸氣
                            instruction.textContent = '吸氣...';
                            breathCircle.classList.remove('breath-animation-exhale', 'breath-animation-hold');
                            breathCircle.classList.add('breath-animation-inhale');
                            phase = 1;
                            setTimeout(updateBreathing, 4000);
                            break;
                        case 1: // 屏息
                            instruction.textContent = '屏息...';
                            breathCircle.classList.remove('breath-animation-inhale', 'breath-animation-exhale');
                            breathCircle.classList.add('breath-animation-hold');
                            phase = 2;
                            setTimeout(updateBreathing, 4000);
                            break;
                        case 2: // 呼氣
                            instruction.textContent = '呼氣...';
                            breathCircle.classList.remove('breath-animation-inhale', 'breath-animation-hold');
                            breathCircle.classList.add('breath-animation-exhale');
                            phase = 0;
                            setTimeout(updateBreathing, 6000);
                            break;
                    }
                }
                
                updateBreathing();
            }
        });
        
        // 情緒追蹤功能
        let viewMode = 'month'; // 'month' 或 'year'
        let currentDate = new Date();
        let emotionData = {}; // 存儲情緒數據 { 'YYYY-MM-DD': emotionValue }

        // 初始化情緒數據 (模擬數據)
        function initEmotionData() {
            const today = new Date();
            const startDate = new Date(today);
            startDate.setMonth(today.getMonth() - 6); // 從六個月前開始
            
            for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                // 隨機生成情緒 (1: 開心, 2: 平靜, 3: 焦慮)
                const emotion = Math.floor(Math.random() * 3) + 1;
                const dateStr = formatDate(d);
                emotionData[dateStr] = emotion;
            }
        }

        // 格式化日期為 'YYYY-MM-DD'
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 更新當前顯示的期間
        function updateCurrentPeriod() {
            const periodEl = document.getElementById('currentPeriod');
            if (viewMode === 'month') {
                periodEl.textContent = `${currentDate.getFullYear()}年${currentDate.getMonth() + 1}月`;
            } else {
                periodEl.textContent = `${currentDate.getFullYear()}年`;
            }
        }

        // 根據情緒值獲取顏色
        function getEmotionColor(emotion) {
            switch(emotion) {
                case 1: return 'bg-green-500'; // 開心
                case 2: return 'bg-yellow-500'; // 平靜
                case 3: return 'bg-red-500'; // 焦慮
                default: return 'bg-gray-300 dark:bg-gray-600'; // 無數據
            }
        }

        // 渲染月視圖
        function renderMonthView() {
            const monthGrid = document.getElementById('monthGrid');
            monthGrid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 獲取當月第一天
            const firstDay = new Date(year, month, 1);
            // 獲取當月最後一天
            const lastDay = new Date(year, month + 1, 0);
            
            // 計算需要顯示的前一個月的日期數量
            const daysFromPrevMonth = firstDay.getDay();
            
            // 創建前一個月的日期單元格
            const prevMonth = new Date(year, month, 0);
            for (let i = prevMonth.getDate() - daysFromPrevMonth + 1; i <= prevMonth.getDate(); i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'aspect-square flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 text-sm';
                dayEl.textContent = i;
                monthGrid.appendChild(dayEl);
            }
            
            // 創建當月的日期單元格
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dateObj = new Date(year, month, i);
                const dateStr = formatDate(dateObj);
                const emotion = emotionData[dateStr] || 0;
                
                const dayEl = document.createElement('div');
                dayEl.className = 'aspect-square p-1 flex flex-col items-center relative';
                
                const dayText = document.createElement('span');
                dayText.className = 'text-sm';
                dayText.textContent = i;
                dayEl.appendChild(dayText);
                
                const emotionIndicator = document.createElement('div');
                emotionIndicator.className = `w-5 h-5 rounded-full mt-1 ${getEmotionColor(emotion)}`;
                dayEl.appendChild(emotionIndicator);
                
                // 如果是今天，添加高亮
                const today = new Date();
                if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === i) {
                    dayEl.classList.add('bg-blue-100', 'dark:bg-blue-900', 'rounded-lg');
                }
                
                monthGrid.appendChild(dayEl);
            }
            
            // 添加下一個月的日期來填充網格
            const daysFromNextMonth = 42 - (daysFromPrevMonth + lastDay.getDate()); // 6行7列 = 42個單元格
            for (let i = 1; i <= daysFromNextMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'aspect-square flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 text-sm';
                dayEl.textContent = i;
                monthGrid.appendChild(dayEl);
            }
        }

        // 渲染年視圖
        function renderYearView() {
            const yearGrid = document.getElementById('yearGrid');
            yearGrid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            
            // 為每個月創建一個單元格
            for (let month = 0; month < 12; month++) {
                const monthEl = document.createElement('div');
                monthEl.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-2 flex flex-col items-center';
                
                // 月份名稱
                const monthName = document.createElement('div');
                monthName.className = 'text-sm font-semibold mb-1';
                monthName.textContent = `${month + 1}月`;
                monthEl.appendChild(monthName);
                
                // 創建情緒指示器的網格
                const miniGrid = document.createElement('div');
                miniGrid.className = 'grid grid-cols-7 gap-px w-full';
                
                // 計算當月總天數
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // 計算當月第一天是星期幾
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                
                // 添加空白單元格
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'aspect-square';
                    miniGrid.appendChild(emptyDay);
                }
                
                // 添加日期單元格
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateObj = new Date(year, month, day);
                    const dateStr = formatDate(dateObj);
                    const emotion = emotionData[dateStr] || 0;
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = `aspect-square ${getEmotionColor(emotion)} rounded-full`;
                    
                    // 如果是今天，添加邊框
                    const today = new Date();
                    if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
                        dayEl.classList.add('border-2', 'border-primary', 'dark:border-dark-primary');
                    }
                    
                    miniGrid.appendChild(dayEl);
                }
                
                monthEl.appendChild(miniGrid);
                yearGrid.appendChild(monthEl);
            }
        }

        // 切換月/年視圖
        function toggleView(newMode) {
            viewMode = newMode;
            
            // 更新按鈕狀態
            document.querySelectorAll('.emotion-view-btn').forEach((btn, index) => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                
                if ((index === 0 && newMode === 'month') || (index === 1 && newMode === 'year')) {
                    btn.classList.add('bg-primary', 'text-white');
                    btn.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                }
            });
            
            // 顯示相應視圖
            if (newMode === 'month') {
                document.getElementById('monthView').classList.remove('hidden');
                document.getElementById('yearView').classList.add('hidden');
            } else {
                document.getElementById('monthView').classList.add('hidden');
                document.getElementById('yearView').classList.remove('hidden');
            }
            
            updateCurrentPeriod();
            renderView();
        }

        // 切換到前一個期間
        function prevPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setFullYear(currentDate.getFullYear() - 1);
            }
            updateCurrentPeriod();
            renderView();
        }

        // 切換到下一個期間
        function nextPeriod() {
            if (viewMode === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentDate.setFullYear(currentDate.getFullYear() + 1);
            }
            updateCurrentPeriod();
            renderView();
        }

        // 根據當前視圖模式渲染視圖
        function renderView() {
            if (viewMode === 'month') {
                renderMonthView();
            } else {
                renderYearView();
            }
        }

        // 初始化情緒追蹤
        function initEmotionTracker() {
            // 初始化模擬情緒數據
            initEmotionData();
            
            // 初始化視圖
            updateCurrentPeriod();
            renderView();
            
            // 設置事件監聽器
            document.querySelectorAll('.emotion-view-btn').forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    toggleView(index === 0 ? 'month' : 'year');
                });
            });
            
            document.querySelector('.prev-period-btn').addEventListener('click', prevPeriod);
            document.querySelector('.next-period-btn').addEventListener('click', nextPeriod);
            
            // 設置表情按鈕點擊事件
            document.querySelectorAll('.emoji-btn').forEach((btn, index) => {
                btn.addEventListener('click', function() {
                    const today = formatDate(new Date());
                    emotionData[today] = index + 1; // 1: 開心, 2: 平靜, 3: 焦慮
                    renderView(); // 重新渲染當前視圖
                });
            });
        }
        
        // 初始化音頻播放器
        initAudioPlayer();
        
        // 初始化情緒追蹤器
        initEmotionTracker();
        
        // 初始化餐廳功能
        initRestaurantFeatures();
    </script>
</body>
</html>
